<% layout('partials/layout') %>

<div class="card" style="max-width:560px; margin:60px auto; text-align:center;">
  <h2>Procesando tu compra...</h2>
  <p>Por favor espera unos segundos mientras completamos el pago.</p>
</div>

<script>
(async () => {
  try {
    const KEY = 'ct_cart';
    const items = JSON.parse(localStorage.getItem(KEY) || '[]');

    if (!Array.isArray(items) || items.length === 0) {
      alert('Tu carrito está vacío.');
      window.location = '/';
      return;
    }

    const res = await fetch('/cart/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items })
    });

    const text = await res.text();

    if (res.ok) {
      // limpiar carrito local y badge
      localStorage.removeItem(KEY);
      localStorage.setItem('ct_cart_count', '0');
      // mostrar comprobante del backend
      document.open();
      document.write(text);
      document.close();
    } else {
      alert('No se pudo completar el checkout: ' + text);
      window.location = '/';
    }
  } catch (err) {
    alert('Error al procesar el checkout: ' + err.message);
    window.location = '/';
  }
})();
</script>
