<% layout('partials/layout') %>

<div class="card" style="max-width:560px">
  <h2>Procesando tu pago…</h2>
  <p>No cierres esta ventana.</p>
</div>

<script>
(async () => {
  try {
    const KEY = 'ct_cart';
    const items = JSON.parse(localStorage.getItem(KEY) || '[]');

    if (!Array.isArray(items) || items.length === 0) {
      alert('Tu carrito está vacío.');
      window.location = '/';
      return;
    }

    const res = await fetch('/cart/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items })
    });

    const text = await res.text();

    if (res.ok) {
      localStorage.removeItem(KEY);
      localStorage.setItem('ct_cart_count', '0');
      document.open(); document.write(text); document.close();
    } else {
      alert('No se pudo completar el checkout: ' + text);
      window.location = '/';
    }
  } catch (e) {
    alert('No se pudo completar el checkout: ' + e.message);
    window.location = '/';
  }
})();
</script>
