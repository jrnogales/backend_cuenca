<% layout('partials/layout') %>

<h2>Crear cuenta</h2>

<% if (typeof error === 'string' && error) { %>
  <div class="notice error"><%= error %></div>
<% } %>

<div class="card" style="max-width:640px;margin:auto;">
  <form method="POST" action="/register" id="f-register">
    <label>Nombre</label>
    <input type="text" name="nombre" required value="<%= nombre || '' %>">

    <label>Apellido</label>
    <input type="text" name="apellido" required value="<%= apellido || '' %>">

    <label>Cédula</label>
    <input
      type="text"
      name="cedula"
      required
      inputmode="numeric"
      autocomplete="off"
      minlength="10"
      maxlength="10"
      pattern="[0-9]{10}"
      placeholder="10 dígitos"
      value="<%= cedula || '' %>"
    >
    <small class="muted">Debe tener 10 dígitos válidos (Ecuador).</small>

    <label>Email</label>
    <input type="email" name="email" required value="<%= email || '' %>">

    <label>Teléfono</label>
    <input type="tel" name="telefono" inputmode="tel" value="<%= telefono || '' %>">

    <label>Contraseña</label>
    <input type="password" name="password" required minlength="6">

    <button type="submit" class="btn" style="width:100%;margin-top:12px;">Registrar</button>
  </form>
</div>

<<script>
// Validación de cédula ecuatoriana (versión estable)
function validarCedulaEc(cedula) {
  // Debe tener exactamente 10 dígitos numéricos
  if (!/^\d{10}$/.test(cedula)) return false;

  const provincia = parseInt(cedula.substring(0, 2), 10);
  if (provincia < 1 || provincia > 24) return false;

  const digitos = cedula.split('').map(Number);
  const verificador = digitos.pop(); // último dígito
  let suma = 0;

  for (let i = 0; i < digitos.length; i++) {
    let valor = digitos[i];
    if (i % 2 === 0) {
      valor *= 2;
      if (valor > 9) valor -= 9;
    }
    suma += valor;
  }

  const decenaSuperior = Math.ceil(suma / 10) * 10;
  const resultado = decenaSuperior - suma;
  const digitoCalculado = resultado === 10 ? 0 : resultado;

  return digitoCalculado === verificador;
}

// Aplicar validación antes del envío
document.getElementById('f-register')?.addEventListener('submit', (e) => {
  const ci = e.target.cedula?.value?.trim() ?? '';
  if (!validarCedulaEc(ci)) {
    e.preventDefault();
    alert('La cédula ingresada no es válida. Verifica los 10 dígitos.');
    e.target.cedula?.focus();
  }
});
</script>
