<% layout('partials/layout') %>

<h2>Crear cuenta</h2>

<% if (typeof error === 'string' && error) { %>
  <div class="notice error"><%= error %></div>
<% } %>

<div class="card" style="max-width:640px;margin:auto;">
  <form method="POST" action="/register" id="f-register">
    <label>Nombre</label>
    <input type="text" name="nombre" required value="<%= nombre || '' %>">

    <label>Apellido</label>
    <input type="text" name="apellido" required value="<%= apellido || '' %>">

    <label>Cédula</label>
    <input
      type="text"
      name="cedula"
      required
      inputmode="numeric"
      autocomplete="off"
      minlength="10"
      maxlength="10"
      pattern="[0-9]{10}"
      placeholder="10 dígitos"
      value="<%= cedula || '' %>"
    >
    <small class="muted">Debe tener 10 dígitos válidos (Ecuador).</small>

    <label>Email</label>
    <input type="email" name="email" required value="<%= email || '' %>">

    <label>Teléfono</label>
    <input type="tel" name="telefono" inputmode="tel" value="<%= telefono || '' %>">

    <label>Contraseña</label>
    <input type="password" name="password" required minlength="6">

    <button type="submit" class="btn" style="width:100%;margin-top:12px;">Registrar</button>
  </form>
</div>

<script>
// Validación de cédula ecuatoriana (formato oficial)
function validarCedulaEc(cedula) {
  if (!/^\d{10}$/.test(cedula)) return false;

  const provincia = parseInt(cedula.substring(0, 2), 10);
  const tercer = parseInt(cedula[2], 10);
  if (provincia < 1 || provincia > 24 || tercer >= 6) return false;

  const coef = [2,1,2,1,2,1,2,1,2];
  const digitos = cedula.split('').map(Number);
  let suma = 0;

  for (let i = 0; i < 9; i++) {
    let valor = digitos[i] * coef[i];
    if (valor >= 10) valor -= 9;
    suma += valor;
  }

  const verificador = (10 - (suma % 10)) % 10;
  return verificador === digitos[9];
}

document.getElementById('f-register')?.addEventListener('submit', (e) => {
  const ci = e.target.cedula?.value?.trim() ?? '';
  if (!validarCedulaEc(ci)) {
    e.preventDefault();
    alert('La cédula ingresada no es válida. Verifica los 10 dígitos correctamente.');
    e.target.cedula?.focus();
  }
});
</script>
