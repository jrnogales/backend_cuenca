<% layout('partials/layout') %>

<!-- Estilos locales solo para el badge -->
<style>
  .resv-badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600;color:#fff;display:inline-block;}
  .resv-ok{background:#10b981;}      /* CONFIRMADA */
  .resv-cancel{background:#ef4444;}  /* CANCELADA */
</style>

<h2>Mis reservas</h2>

<% if (!reservas || reservas.length === 0) { %>
  <div class="notice">AÃºn no tienes reservas.</div>
<% } else { %>
  <div class="cards">
    <%
      var ahoraMs = Date.now();

      // ðŸ”’ Parser de fecha robusto a cualquier formato (string YYYY-MM-DD, ISO, o Date)
      function inicioLocalDeFecha(fv) {
        if (!fv) return new Date(0); // pasado remoto -> no cancelable
        // 1) Si es string 'YYYY-MM-DD' exacto
        var s = String(fv);
        var m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (m) {
          var y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
          return new Date(y, mo, d, 0, 0, 0, 0); // LOCAL
        }
        // 2) Si es Date o ISO, leer componente UTC y construir LOCAL a medianoche
        var dt = new Date(fv);
        if (!isNaN(dt.getTime())) {
          var y2 = dt.getUTCFullYear ? dt.getUTCFullYear() : dt.getFullYear();
          var mo2 = dt.getUTCMonth   ? dt.getUTCMonth()    : dt.getMonth();
          var d2  = dt.getUTCDate    ? dt.getUTCDate()     : dt.getDate();
          return new Date(y2, mo2, d2, 0, 0, 0, 0); // LOCAL
        }
        return new Date(0);
      }

      reservas.forEach(function(r) {
        var inicio = inicioLocalDeFecha(r.fecha_viaje);   // âœ… medianoche LOCAL del dÃ­a de viaje
        var diffMs = inicio.getTime() - ahoraMs;

        var estado = r.estado || 'CONFIRMADA';
        var dentroVentana = diffMs >= (8*60*60*1000);     // â‰¥ 8 horas
        var cancelable = (estado === 'CONFIRMADA') && dentroVentana;
        var badgeClass = (estado === 'CANCELADA') ? 'resv-badge resv-cancel' : 'resv-badge resv-ok';
    %>
      <article class="card" style="display:grid;grid-template-columns:160px 1fr;gap:16px">
        <div class="pic">
          <img src="<%= r.imagen || '' %>" alt="<%= r.titulo %>" loading="lazy" width="160">
        </div>
        <div>
          <h3 style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span><%= r.titulo %></span>
            <span class="<%= badgeClass %>"><%= estado %></span>
          </h3>

          <p><b>CÃ³digo:</b> <%= r.codigo_reserva %></p>
          <p><b>Fecha del viaje:</b> <%= r.fecha_viaje %></p>
          <p><b>Pasajeros:</b> <%= r.adultos %> adultos Â· <%= r.ninos %> niÃ±os</p>
          <p><b>Total:</b> $<%= Number(r.total_usd||0).toFixed(2) %></p>

          <% if (cancelable) { %>
            <form method="POST" action="/reservas/<%= r.codigo_reserva %>/cancelar"
                  onsubmit="return confirm('Â¿Cancelar esta reserva?');">
              <button class="btn-danger">Cancelar</button>
            </form>
          <% } else { %>
            <% if (estado === 'CANCELADA') { %>
              <div class="notice">Esta reserva fue cancelada y los cupos se repusieron.</div>
            <% } else { %>
              <div class="notice">Esta reserva ya no se puede cancelar (menos de 8 horas).</div>
            <% } %>
          <% } %>
        </div>
      </article>
    <% }); %>
  </div>
<% } %>
