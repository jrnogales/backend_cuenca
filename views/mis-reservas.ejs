<% layout('partials/layout') %>

<!-- Estilos locales solo para el badge -->
<style>
  .resv-badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600;color:#fff;display:inline-block;}
  .resv-ok{background:#10b981;}      /* CONFIRMADA */
  .resv-cancel{background:#ef4444;}  /* CANCELADA */
</style>

<h2>Mis reservas</h2>

<% if (!reservas || reservas.length === 0) { %>
  <div class="notice">Aún no tienes reservas.</div>
<% } else { %>
  <div class="cards">
    <%
      // Usamos 'var' para evitar warnings del parser de algunas extensiones
      var ahoraMs = Date.now();
      reservas.forEach(function(r) {
        // ✅ Medianoche local: evita que el parseo 'YYYY-MM-DD' se interprete como UTC
        var parts = String(r.fecha_viaje || '').split('-');         // ['2025','10','30']
        var y = parseInt(parts[0] || '0', 10);
        var m = parseInt(parts[1] || '1', 10) - 1;                  // 0-based
        var d = parseInt(parts[2] || '1', 10);
        var inicio = new Date(y, m, d, 0, 0, 0, 0);                  // <-- LOCAL

        var diffMs = inicio.getTime() - ahoraMs;
        var estado = r.estado || 'CONFIRMADA';
        var dentroVentana = diffMs >= (8*60*60*1000);
        var cancelable = (estado === 'CONFIRMADA') && dentroVentana;
        var badgeClass = (estado === 'CANCELADA') ? 'resv-badge resv-cancel' : 'resv-badge resv-ok';
    %>
      <article class="card" style="display:grid;grid-template-columns:160px 1fr;gap:16px">
        <div class="pic">
          <img src="<%= r.imagen || '' %>" alt="<%= r.titulo %>" loading="lazy" width="160">
        </div>
        <div>
          <h3 style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span><%= r.titulo %></span>
            <span class="<%= badgeClass %>"><%= estado %></span>
          </h3>

          <p><b>Código:</b> <%= r.codigo_reserva %></p>
          <p><b>Fecha del viaje:</b> <%= r.fecha_viaje %></p>
          <p><b>Pasajeros:</b> <%= r.adultos %> adultos · <%= r.ninos %> niños</p>
          <p><b>Total:</b> $<%= Number(r.total_usd||0).toFixed(2) %></p>

          <% if (cancelable) { %>
            <form method="POST" action="/reservas/<%= r.codigo_reserva %>/cancelar"
                  onsubmit="return confirm('¿Cancelar esta reserva?');">
              <button class="btn-danger">Cancelar</button>
            </form>
          <% } else { %>
            <% if (estado === 'CANCELADA') { %>
              <div class="notice">Esta reserva fue cancelada y los cupos se repusieron.</div>
            <% } else { %>
              <div class="notice">Esta reserva ya no se puede cancelar (menos de 8 horas).</div>
            <% } %>
          <% } %>
        </div>
      </article>
    <% }); %>
  </div>
<% } %>
