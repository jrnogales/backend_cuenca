<% layout('partials/layout') %>

<section class="toolbar">
  <form id="filtros" onsubmit="event.preventDefault()">
    <div class="group">
      <label>Seleccionar fechas</label>
      <input type="date" id="f-fecha">
    </div>

    <div class="group">
      <label>Adultos</label>
      <select id="f-adultos">
        <% for (let i=1;i<=10;i++){ %>
          <option value="<%= i %>" <%= i===2?'selected':'' %>><%= i %></option>
        <% } %>
      </select>
    </div>

    <div class="group">
      <label>Ni√±os</label>
      <select id="f-ninos">
        <% for (let i=0;i<=10;i++){ %>
          <option value="<%= i %>"><%= i %></option>
        <% } %>
      </select>
    </div>

    <button id="btn-aplicar" class="btn-primary outline" type="button">Aplicar</button>
  </form>
</section>

<% if (error) { %>
  <div class="notice error"><%= error %></div>
<% } %>

<% if (!paquetes || paquetes.length===0) { %>
  <div class="notice">No hay paquetes disponibles por ahora.</div>
<% } %>

<section class="cards">
  <% (paquetes||[]).forEach(p => { 
      const pa = Number(p.precio_adulto||0);
      const pn = Number(p.precio_nino||0);
  %>
    <article class="card" 
      data-id="<%= p.codigo %>" 
      data-pa="<%= pa %>" 
      data-pn="<%= pn %>"
      data-img="<%= p.imagen || '' %>"
      data-title="<%= p.titulo %>">

      <div class="pic">
        <!-- Usar solo URL alojada en BD -->
        <img src="<%= p.imagen || '' %>" alt="<%= p.titulo %>" loading="lazy">
      </div>

      <div class="card-body">
        <h3 class="title"><%= p.titulo %></h3>

        <p class="meta">
          <span class="dot"></span> 
          <%= p.ciudad || 'Cuenca' %> ¬∑ 
          <%= (p.duracion_dias||1) %> horas
        </p>

        <ul class="perks">
          <li><span class="icon">‚úî</span> Cancelaci√≥n gratuita</li>
          <li><span class="icon">üïí</span> <%= (p.duracion_horas|| (p.duracion_dias||1)*8) %> h</li>
        </ul>

        <div class="divider"></div>

        <div class="price-n-cta">
          <div class="prices">
            <div class="from">a partir de</div>
            <div class="usd">$<%= pa.toFixed(2) %> <span class="suffix">US$</span></div>
            <div class="note">El precio var√≠a en funci√≥n del n√∫mero de personas por grupo</div>
          </div>

          <!-- Controles de cantidad -->
          <div class="qty">
            <label>Adultos</label>
            <input type="number" class="in-adultos" min="1" max="20" value="2">
          </div>
          <div class="qty">
            <label>Ni√±os</label>
            <input type="number" class="in-ninos" min="0" max="20" value="0">
          </div>

          <div class="total">Total: <strong class="total-val">$0.00</strong></div>

          <!-- Bot√≥n A√±adir al carrito -->
          <button class="btn-primary add-cart" type="button">A√±adir al carrito</button>
        </div>
      </div>
    </article>
  <% }) %>
</section>

<script>
  (function () {
    // === FECHA M√çNIMA: hoy en formato local YYYY-MM-DD ===
    function todayLocalISO() {
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); // evita saltos de d√≠a por zona horaria
      return d.toISOString().slice(0, 10);
    }

    const $adultSel = document.getElementById('f-adultos');
    const $ninoSel  = document.getElementById('f-ninos');
    const $fecha    = document.getElementById('f-fecha');
    const $apply    = document.getElementById('btn-aplicar');

    // Fijar min y valor inicial v√°lido para el date
    $fecha.min = todayLocalISO();
    if (!$fecha.value || $fecha.value < $fecha.min) {
      $fecha.value = $fecha.min;
    }

    function calcCard(card) {
      const pa = parseFloat(card.dataset.pa || '0');
      const pn = parseFloat(card.dataset.pn || '0');
      const inA = card.querySelector('.in-adultos');
      const inN = card.querySelector('.in-ninos');
      const totalEl = card.querySelector('.total-val');

      const A = Math.max(1, parseInt(inA.value || '1', 10));
      const N = Math.max(0, parseInt(inN.value || '0', 10));
      const total = A * pa + N * pn;

      totalEl.textContent = '$' + total.toFixed(2);
    }

    // Inicializa todas las tarjetas
    document.querySelectorAll('.card').forEach(card => {
      // valores por defecto desde la toolbar
      card.querySelector('.in-adultos').value = parseInt($adultSel.value, 10);
      card.querySelector('.in-ninos').value   = parseInt($ninoSel.value, 10);
      calcCard(card);

      // listeners para rec√°lculo
      card.querySelector('.in-adultos').addEventListener('input', () => calcCard(card));
      card.querySelector('.in-ninos').addEventListener('input', () => calcCard(card));

      // bot√≥n A√±adir al carrito
      const btnAdd = card.querySelector('.add-cart');
      btnAdd.addEventListener('click', () => {
        // Validaci√≥n de fecha
        if (!$fecha.value) {
          alert('Selecciona una fecha.');
          return;
        }
        if ($fecha.value < $fecha.min) {
          $fecha.value = $fecha.min;
          alert('No puedes seleccionar una fecha pasada.');
          return;
        }

        const pa = parseFloat(card.dataset.pa || '0');
        const pn = parseFloat(card.dataset.pn || '0');
        const img = card.dataset.img || '';
        const titulo = card.dataset.title || 'Paquete';
        const codigo = card.dataset.id;
        const A = Math.max(1, parseInt(card.querySelector('.in-adultos').value || '1', 10));
        const N = Math.max(0, parseInt(card.querySelector('.in-ninos').value   || '0', 10));

        const item = {
          codigo,
          titulo,
          fecha: $fecha.value,
          adultos: A,
          ninos: N,
          pa, pn,
          img
        };

        if (typeof addToCart === 'function') {
          addToCart(item);
          // feedback corto
          btnAdd.textContent = 'A√±adido ‚úì';
          setTimeout(()=>{ btnAdd.textContent = 'A√±adir al carrito'; }, 900);
        } else {
          alert('No se pudo acceder al carrito.');
        }
      });
    });

    // Si el usuario cambia la fecha, mantenerla v√°lida y recalcular totales
    $fecha.addEventListener('change', () => {
      if ($fecha.value < $fecha.min) $fecha.value = $fecha.min;
      document.querySelectorAll('.card').forEach(card => calcCard(card));
    });

    // Bot√≥n "Aplicar" sincroniza cantidades con todas las tarjetas
    $apply.addEventListener('click', () => {
      if ($fecha.value < $fecha.min) $fecha.value = $fecha.min;
      document.querySelectorAll('.card').forEach(card => {
        card.querySelector('.in-adultos').value = parseInt($adultSel.value, 10);
        card.querySelector('.in-ninos').value   = parseInt($ninoSel.value, 10);
        calcCard(card);
      });
    });
  })();
</script>
