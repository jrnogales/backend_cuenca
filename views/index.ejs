<% layout('partials/layout') %>

<section class="toolbar">
  <form id="filtros" onsubmit="event.preventDefault()">
    <div class="group">
      <label>Seleccionar fechas</label>
      <input type="date" id="f-fecha">
    </div>

    <div class="group">
      <label>Adultos</label>
      <select id="f-adultos">
        <% for (let i=1;i<=10;i++){ %>
          <option value="<%= i %>" <%= i===2?'selected':'' %>><%= i %></option>
        <% } %>
      </select>
    </div>

    <div class="group">
      <label>Ni√±os</label>
      <select id="f-ninos">
        <% for (let i=0;i<=10;i++){ %>
          <option value="<%= i %>"><%= i %></option>
        <% } %>
      </select>
    </div>

    <button id="btn-aplicar" class="btn-primary outline" type="button">Aplicar</button>
  </form>
</section>

<% if (error) { %>
  <div class="notice error"><%= error %></div>
<% } %>

<% if (!paquetes || paquetes.length===0) { %>
  <div class="notice">No hay paquetes disponibles por ahora.</div>
<% } %>

<section class="cards">
  <% (paquetes||[]).forEach(p => { 
      const pa = Number(p.precio_adulto||0);
      const pn = Number(p.precio_nino||0);
  %>
    <article class="card" 
      data-id="<%= p.codigo %>" 
      data-pa="<%= pa %>" 
      data-pn="<%= pn %>"
      data-img="<%= p.imagen || '' %>"
      data-title="<%= p.titulo %>">

      <div class="pic">
        <!-- Usar solo URL alojada en BD -->
        <img src="<%= p.imagen || '' %>" alt="<%= p.titulo %>" loading="lazy">
      </div>

      <div class="card-body">
        <h3 class="title"><%= p.titulo %></h3>

        <p class="meta">
          <span class="dot"></span> 
          <%= p.ciudad || 'Cuenca' %> ¬∑ 
          <%= (p.duracion_dias||1) %> horas
        </p>

        <ul class="perks">
          <li><span class="icon">‚úî</span> Cancelaci√≥n gratuita</li>
          <li><span class="icon">üïí</span> <%= (p.duracion_horas|| (p.duracion_dias||1)*8) %> h</li>
        </ul>

        <div class="divider"></div>

        <div class="price-n-cta">
          <div class="prices">
            <div class="from">a partir de</div>
            <div class="usd">$<%= pa.toFixed(2) %> <span class="suffix">US$</span></div>
            <div class="note">El precio var√≠a en funci√≥n del n√∫mero de personas por grupo</div>
          </div>

          <!-- Controles de cantidad -->
          <div class="qty">
            <label>Adultos</label>
            <input type="number" class="in-adultos" min="1" max="20" value="2">
          </div>
          <div class="qty">
            <label>Ni√±os</label>
            <input type="number" class="in-ninos" min="0" max="20" value="0">
          </div>

          <div class="total">Total: <strong class="total-val">$0.00</strong></div>

          <!-- Bot√≥n A√±adir al carrito -->
          <button class="btn-primary add-cart" type="button">A√±adir al carrito</button>
        </div>
      </div>
    </article>
  <% }) %>
</section>

<script>
  (function () {
    // ===== util fecha hoy en local YYYY-MM-DD =====
    function todayLocalISO() {
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0, 10);
    }

    // ===== referencias UI existentes =====
    const $adultSel = document.getElementById('f-adultos');
    const $ninoSel  = document.getElementById('f-ninos');
    const $fecha    = document.getElementById('f-fecha');
    const $apply    = document.getElementById('btn-aplicar');

    // fecha min + valor por defecto
    if ($fecha) {
      $fecha.min = todayLocalISO();
      if (!$fecha.value || $fecha.value < $fecha.min) $fecha.value = $fecha.min;
    }

    // ===== c√°lculo por tarjeta =====
    function calcCard(card){
      const pa = Number(card.dataset.pa || 0); // precio adulto
      const pn = Number(card.dataset.pn || 0); // precio ni√±o

      const inA = card.querySelector('.in-adultos');
      const inN = card.querySelector('.in-ninos');
      const totalEl = card.querySelector('.total-val');

      const A = Math.max(1, parseInt(inA?.value ?? '1', 10));
      const N = Math.max(0, parseInt(inN?.value ?? '0', 10));

      const total = (A * pa) + (N * pn);
      if (totalEl) totalEl.textContent = '$' + total.toFixed(2);

      // sync hidden inputs para tu POST /checkout (por si lo usas)
      const hA = card.querySelector('.h-adultos');
      const hN = card.querySelector('.h-ninos');
      const hF = card.querySelector('.h-fecha');
      const hT = card.querySelector('.h-total');
      if (hA) hA.value = A;
      if (hN) hN.value = N;
      if (hF) hF.value = $fecha?.value || '';
      if (hT) hT.value = total.toFixed(2);
    }

    // ===== inicializaci√≥n de todas las tarjetas =====
    document.querySelectorAll('.card[data-id]').forEach(card=>{
      // sync inicial con selectores de la toolbar
      const inA = card.querySelector('.in-adultos');
      const inN = card.querySelector('.in-ninos');
      if (inA) inA.value = parseInt($adultSel?.value ?? '2', 10);
      if (inN) inN.value = parseInt($ninoSel?.value ?? '0', 10);
      calcCard(card);

      // listeners de cantidad
      inA?.addEventListener('input', ()=>calcCard(card));
      inN?.addEventListener('input', ()=>calcCard(card));

      // seguridad si alguien env√≠a el form (aunque ahora usamos carrito)
      const form = card.querySelector('form.buy');
      form?.addEventListener('submit', (e)=>{
        if (!$fecha?.value) { e.preventDefault(); alert('Selecciona una fecha.'); return; }
        if ($fecha.value < $fecha.min) { e.preventDefault(); $fecha.value = $fecha.min; alert('No puedes seleccionar una fecha pasada.'); return; }
        calcCard(card);
      });

      // ===== A√±adir al carrito =====
      const btnAdd = card.querySelector('.btn-add-cart, .btn-primary.btn-add-cart') || card.querySelector('button.btn-primary'); // por si variaron clases
      if (btnAdd && btnAdd.textContent.toLowerCase().includes('a√±adir')) {
        btnAdd.addEventListener('click', ()=>{
          if (!$fecha?.value) { alert('Selecciona una fecha antes de a√±adir.'); return; }
          if ($fecha.value < $fecha.min) { $fecha.value = $fecha.min; }

          const item = {
            codigo: card.dataset.id,
            titulo: (card.querySelector('.title')?.textContent || card.dataset.id).trim(),
            fecha:  $fecha.value,
            adultos: Math.max(1, parseInt(card.querySelector('.in-adultos')?.value ?? '1', 10)),
            ninos:   Math.max(0, parseInt(card.querySelector('.in-ninos')?.value ?? '0', 10)),
            pa: Number(card.dataset.pa || 0),
            pn: Number(card.dataset.pn || 0),
            img: card.querySelector('.pic img')?.src || ''
          };

          // fallback en caso de que el script global no est√© cargado a√∫n
          if (typeof addToCart === 'function') {
            addToCart(item);
          } else {
            const KEY='cart_v1';
            let list=[]; try{ list=JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{}
            list.push(item);
            localStorage.setItem(KEY, JSON.stringify(list));
            // si luego carga el global, que refresque el badge
            if (typeof updateCartUI === 'function') updateCartUI();
          }

          // feedback sutil
          const prev = btnAdd.textContent;
          btnAdd.disabled = true;
          btnAdd.textContent = 'A√±adido ‚úì';
          setTimeout(()=>{ btnAdd.textContent = prev; btnAdd.disabled = false; }, 900);
        });
      }
    });

    // al cambiar fecha, recalc
    $fecha?.addEventListener('change', ()=>{
      if ($fecha.value < $fecha.min) $fecha.value = $fecha.min;
      document.querySelectorAll('.card[data-id]').forEach(calcCard);
    });

    // Bot√≥n "Aplicar": sincroniza cantidades con todas las tarjetas
    $apply?.addEventListener('click', ()=>{
      if ($fecha.value < $fecha.min) $fecha.value = $fecha.min;
      document.querySelectorAll('.card[data-id]').forEach(card=>{
        const inA = card.querySelector('.in-adultos');
        const inN = card.querySelector('.in-ninos');
        if (inA) inA.value = parseInt($adultSel?.value ?? '2', 10);
        if (inN) inN.value = parseInt($ninoSel?.value ?? '0', 10);
        calcCard(card);
      });
    });
  })();
</script>
