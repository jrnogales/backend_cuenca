<% layout('partials/layout') %>

<section class="toolbar">
  <form id="filtros" onsubmit="event.preventDefault()">
    <div class="group">
      <label>Seleccionar fechas</label>
      <input type="date" id="f-fecha">
    </div>

    <div class="group">
      <label>Adultos</label>
      <select id="f-adultos">
        <% for (let i=1;i<=10;i++){ %>
          <option value="<%= i %>" <%= i===2?'selected':'' %>><%= i %></option>
        <% } %>
      </select>
    </div>

    <div class="group">
      <label>NiÃ±os</label>
      <select id="f-ninos">
        <% for (let i=0;i<=10;i++){ %>
          <option value="<%= i %>"><%= i %></option>
        <% } %>
      </select>
    </div>

    <button id="btn-aplicar" class="btn-primary outline">Aplicar</button>
  </form>
</section>

<% if (error) { %>
  <div class="notice error"><%= error %></div>
<% } %>

<% if (!paquetes || paquetes.length===0) { %>
  <div class="notice">No hay paquetes disponibles por ahora.</div>
<% } %>

<section class="cards">
  <% (paquetes||[]).forEach(p => { 
      const pa = Number(p.precio_adulto||0);
      const pn = Number(p.precio_nino||0);
  %>
    <article class="card" 
      data-id="<%= p.codigo %>" 
      data-pa="<%= pa %>" 
      data-pn="<%= pn %>">

      <div class="pic">
        <img src="<%= p.imagen ? ('/img/'+p.imagen) : '/img/noimg.jpg' %>" alt="<%= p.titulo %>" loading="lazy">
      </div>

      <div class="card-body">
        <h3 class="title"><%= p.titulo %></h3>

        <p class="meta">
          <span class="dot"></span> 
          <%= p.ciudad || 'Cuenca' %> Â· 
          <%= (p.duracion_dias||1) %> horas
        </p>

        <ul class="perks">
          <li><span class="icon">âœ”</span> CancelaciÃ³n gratuita</li>
          <li><span class="icon">ðŸ•’</span> <%= (p.duracion_horas|| (p.duracion_dias||1)*8) %> h</li>
        </ul>

        <div class="divider"></div>

        <div class="price-n-cta">
          <div class="prices">
            <div class="from">a partir de</div>
            <div class="usd">$<%= pa.toFixed(2) %> <span class="suffix">US$</span></div>
            <div class="note">El precio varÃ­a en funciÃ³n del nÃºmero de personas por grupo</div>
          </div>

          <form class="buy" method="POST" action="/checkout">
            <input type="hidden" name="paqueteId" class="h-id" value="<%= p.codigo %>">
            <input type="hidden" name="fecha"      class="h-fecha">
            <input type="hidden" name="adultos"    class="h-adultos">
            <input type="hidden" name="ninos"      class="h-ninos">
            <input type="hidden" name="total"      class="h-total">

            <div class="qty">
              <label>Adultos</label>
              <input type="number" class="in-adultos" min="1" max="20" value="2">
            </div>
            <div class="qty">
              <label>NiÃ±os</label>
              <input type="number" class="in-ninos" min="0" max="20" value="0">
            </div>

            <div class="total">Total: <strong class="total-val">$0.00</strong></div>
            <button class="btn-primary">Comprar</button>
          </form>
        </div>
      </div>
    </article>
  <% }) %>
</section>

<script>
  (function(){
    const $adultSel = document.getElementById('f-adultos');
    const $ninoSel  = document.getElementById('f-ninos');
    const $fecha    = document.getElementById('f-fecha');
    const $apply    = document.getElementById('btn-aplicar');

    function calcCard(card){
      const pa = parseFloat(card.dataset.pa || '0');
      const pn = parseFloat(card.dataset.pn || '0');
      const inA = card.querySelector('.in-adultos');
      const inN = card.querySelector('.in-ninos');
      const totalEl = card.querySelector('.total-val');

      const A = Math.max(1, parseInt(inA.value || '1', 10));
      const N = Math.max(0, parseInt(inN.value || '0', 10));
      const total = A*pa + N*pn;

      totalEl.textContent = '$' + total.toFixed(2);

      card.querySelector('.h-adultos').value = A;
      card.querySelector('.h-ninos').value   = N;
      card.querySelector('.h-fecha').value   = $fecha.value || '';
      card.querySelector('.h-total').value   = total.toFixed(2);
    }

    document.querySelectorAll('.card').forEach(card=>{
      // sync con la toolbar
      card.querySelector('.in-adultos').value = parseInt($adultSel.value, 10);
      card.querySelector('.in-ninos').value   = parseInt($ninoSel.value, 10);
      calcCard(card);

      // listeners
      card.querySelector('.in-adultos').addEventListener('input', ()=>calcCard(card));
      card.querySelector('.in-ninos').addEventListener('input', ()=>calcCard(card));
      card.querySelector('form.buy').addEventListener('submit', ()=>calcCard(card));
    });

    $apply.addEventListener('click', ()=>{
      document.querySelectorAll('.card').forEach(card=>{
        card.querySelector('.in-adultos').value = parseInt($adultSel.value,10);
        card.querySelector('.in-ninos').value   = parseInt($ninoSel.value,10);
        calcCard(card);
      });
    });
  })();
</script>
